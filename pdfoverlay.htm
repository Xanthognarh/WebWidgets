<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PDF Viewer</title>
    <style>
		body{
			margin:0;
			background-color: rgba(0,0,0,0);
		}
        #canvas-container {
            position: relative;
        }
        canvas {
            border: 0px solid white;
			background-color:lightgreen;
            display: block;
        }
		#All{
			width:100%;
			height:100%;
			position:absolute;
			display:flex;
			align-items:flex-end;
			justify-content:center;
		}
        #Help{
            position:absolute;
            width:100%;
            height:100%;
            margin:0;
            padding:0;
            background-color:rgba(150,150,150,0.5);
        }
        #Placeholder{
            width:100%;
            height:100%;
            margin:0;
            padding:0;
        }
        #Placeholder div{
            width:100%;
            height:100%;
            margin:0;
            padding:0;
            position:absolute;
			display:flex;
        }
        #Placeholder div span {
            width:calc(100vw / 5);
            height:calc(100vh / 5);
            background-color:green;
            text-align:center;
            font-size:calc(100vh / 5);
        }
        #p1{align-items:flex-end;justify-content:flex-start;}
        #p2{align-items:flex-end;justify-content:center;}
        #p3{align-items:flex-end;justify-content:flex-end;}
        #p4{align-items:center;justify-content:flex-start;}
        #p5{align-items:center;justify-content:center;}
        #p6{align-items:center;justify-content:flex-end;}
        #p7{align-items:flex-start;justify-content:flex-start;}
        #p8{align-items:flex-start;justify-content:center;}
        #p9{align-items:flex-start;justify-content:flex-end;}
        #Anleitung{
            position:absolute;
            height:calc(100vh / 5);
            top:calc(100vh / 5);
            font-size:calc(100vh / 20);
            text-align:center;
        }
        #Commands{
            position:absolute;
            height:calc(100vh / 5);
            top:calc(100vh / 5 * 3);
            font-size:calc(100vh / 40);
        }
        strong{
            text-align:initial;
            font-size:inherit;
            display:contents;
            white-space:nowrap;
        }
        #Commands div span{
            background: #7fc3ff;
            margin: 5px;
            border-radius: 10px;
            padding: 4px;
            font-size:calc(100vh / 30);
            line-height: calc(100vh / 30 + 15px);
        }
        #Commands div{
            width:100%;
        }
    </style>
	<script src="Scripts/tmi.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/pdfjs-dist@5/build/pdf.min.mjs"></script>
</head>
<body onclick="document.getElementById('fileInput').click();">
<div id="All">
    <input type="file" id="fileInput" style="display: none;" accept="application/pdf">
    <div id="canvas-container">
        <canvas id="pdfCanvas"></canvas>
    </div>
</div>
<div id="Help">
    <div id="Placeholder">
        <div id="p1"><span>1<span></div>
        <div id="p2"><span>2<span></div>
        <div id="p3"><span>3<span></div>
        <div id="p4"><span>4<span></div>
        <div id="p5"><span>5<span></div>
        <div id="p6"><span>6<span></div>
        <div id="p7"><span>7<span></div>
        <div id="p8"><span>8<span></div>
        <div id="p9"><span>9<span></div>
    </div>
    <div id="Anleitung">Open a PDF by clicking (OBS: Use the 'Interact' Button to open the interactive window) anywhere on this page. A file open dialog should open.</div>
    <div id="Commands"></div>
</div>
    <script type="module" >
const DisableCommand="!hidepdf";
const EnableCommand="!showpdf";
const NextCommand="!pdf+";
const PreviousCommand="!pdf-";
const SetPageCommand="!pdf";
const RotatePageCommand="!pdfrotation";
const SetScaleCommand="!pdfzoom";
const SetPosCommand="!pdfpos";

let rotationangle=0;
let zoom=0;

const extraMods=[]; //only lower-case usernames (like in the url): extraMods=["name1","name2"];

const siteURL=new URL(window.location);
let TwitchChannel="";
try{
    TwitchChannel=siteURL.searchParams.get("channel").toLowerCase().split(",");
}catch{
    document.getElementById("Anleitung").innerHTML="<strong style='color:red'>!!! Add ?channel=YourChannelName to the URL !!!</strong>";
    throw new Error("Channelname missing in url");
}	
let pos=siteURL.searchParams.get("pos");
if (pos==null){pos="7"}

document.getElementById("Commands").innerHTML=`<div>Commands for Mods and ${[TwitchChannel,extraMods.join(', ')].join(', ')}:</div><div><span>Next Page: <strong>${NextCommand}</strong></span><span> Previous Page: <strong>${PreviousCommand}</strong></span><span> Set Page: <strong>${SetPageCommand}</strong></span><span> Show/Hide: <strong>${EnableCommand}/${DisableCommand}</strong></span><span> Rotate: <strong>${RotatePageCommand}</strong> 0/1=90°/2=180°/3=270°</span><span> Zoom <strong>${SetScaleCommand}</strong> 100</span><span> Move <strong>${SetPosCommand}</strong> 1-9 [offset-x] [offset-y]</span></div>`;
	
	
import { getDocument } from 'https://cdn.jsdelivr.net/npm/pdfjs-dist@5/build/pdf.min.mjs';
pdfjsLib.GlobalWorkerOptions.workerSrc ='https://cdn.jsdelivr.net/npm/pdfjs-dist@5/build/pdf.worker.min.mjs';

let pdfDoc = null;
let currentPage = 1;
const pdfCanvas = document.getElementById('pdfCanvas');
const All=document.getElementById('All');
document.getElementById('fileInput').addEventListener('change', loadPDF);

async function loadPDF(event) {
	const file = event.target.files[0];
	if (file) {
		const fileURL = URL.createObjectURL(file);
		pdfDoc = await pdfjsLib.getDocument(fileURL).promise;
		currentPage = 1;
		renderPage(currentPage);
		ChangePosition(pos);
        document.getElementById("Help").style.visibility="hidden";
	}else{
        document.getElementById("Help").style.visibility="visible";
    }
}
async function renderPage(num) {
	const page = await pdfDoc.getPage(num);
	const desiredHeight = window.screen.availHeight ;
	const desiredWidth = window.screen.availWidth ;
	const viewport = page.getViewport({ scale: 1, rotation: rotationangle});
	let scale = Math.min(desiredHeight / viewport.height, desiredWidth / viewport.width);
	if (zoom!=0){ 
		scale=zoom*scale/100;
	}
	const scaledViewport = page.getViewport({ scale: scale, rotation: rotationangle});

	pdfCanvas.width = scaledViewport.width;
	pdfCanvas.height = scaledViewport.height;
	console.log("Render Page "+num+" with scale "+scale+" and rotation "+rotationangle);
	await page.render({canvasContext: pdfCanvas.getContext('2d'), viewport: scaledViewport}).promise;
}

function nextPage(amount=1) {
	console.log("Next "+amount);
	if (pdfDoc){
		if (currentPage+amount <= pdfDoc.numPages) {
		currentPage+=amount;
		}else{
			currentPage=pdfDoc.numPages;
		}
	renderPage(currentPage);
	}
}

function previousPage(amount=1) {
	console.log("Previous "+amount);
	if (pdfDoc){
		if (currentPage-amount >1) {
		currentPage-=amount;
		}else{
			currentPage=1;
		}
	renderPage(currentPage);
	}
}

function jumpToPage(pageNum) {
	if (pdfDoc && pageNum > 0 && pageNum <= pdfDoc.numPages) {
		currentPage = pageNum;
		renderPage(currentPage);
	}
}

function rotate(angle){
	if (pdfDoc){
		switch(angle){
			case 0:
			case 360:
			case 4:
			rotationangle=0;
			break;
			case 1:
			case 90:
			rotationangle=90;
			break;
			case 2:
			case 180:
			rotationangle=180;
			break;
			case 3:
			case 270:
			rotationangle=270;
			break;
		}
		renderPage(currentPage);
	}
}

function fixedscale(val=0){
	zoom=val;
	renderPage(currentPage);
}

function ChangePosition(text){
	let offsetx=text.split(" ")[1]*1;
	let offsety=text.split(" ")[2]*1;
	if (isNaN(offsety)){offsety=0;}
	if (isNaN(offsetx)){offsetx=0;}
	const margin="0%";
	pos=text[0]*1;
	switch (pos){
		case 7:
			All.style.alignItems="flex-start";
			All.style.justifyContent="flex-start";
			pdfCanvas.style.marginLeft="calc("+margin+" + "+offsetx+"px)";
			pdfCanvas.style.marginTop="calc("+margin+" + "+offsety+"px)";
			pdfCanvas.style.marginRight=margin;
			pdfCanvas.style.marginBottom=margin;
			break;
		case 8:
			All.style.alignItems="flex-start";
			All.style.justifyContent="center";
			pdfCanvas.style.marginLeft="calc("+margin+" + "+offsetx+"px)";
			pdfCanvas.style.marginTop="calc("+margin+" + "+offsety+"px)";
			pdfCanvas.style.marginRight=margin;
			pdfCanvas.style.marginBottom=margin;
			break;
		case 9:
			All.style.alignItems="flex-start";
			All.style.justifyContent="flex-end";
			pdfCanvas.style.marginLeft=margin;
			pdfCanvas.style.marginTop="calc("+margin+" + "+offsety+"px)";
			pdfCanvas.style.marginRight="calc("+margin+" - "+offsetx+"px)";
			pdfCanvas.style.marginBottom=margin;
			break;
			
		case 4:
			All.style.alignItems="center";
			All.style.justifyContent="flex-start";
			pdfCanvas.style.marginLeft="calc("+margin+" + "+offsetx+"px)";
			pdfCanvas.style.marginTop="calc("+margin+" + "+offsety+"px)";
			pdfCanvas.style.marginRight=margin;
			pdfCanvas.style.marginBottom=margin;
			break;
		case 5:
			All.style.alignItems="center";
			All.style.justifyContent="center";
			pdfCanvas.style.marginLeft="calc("+margin+" + "+offsetx+"px)";
			pdfCanvas.style.marginTop="calc("+margin+" + "+offsety+"px)";
			pdfCanvas.style.marginRight=margin;
			pdfCanvas.style.marginBottom=margin;
			break;
		case 6:
			All.style.alignItems="center";
			All.style.justifyContent="flex-end";
			pdfCanvas.style.marginLeft=margin;
			pdfCanvas.style.marginTop="calc("+margin+" + "+offsety+"px)";
			pdfCanvas.style.marginRight="calc("+margin+" - "+offsetx+"px)";
			pdfCanvas.style.marginBottom=margin;
			break;
		
		case 1:
			All.style.alignItems="flex-end";
			All.style.justifyContent="flex-start";
			pdfCanvas.style.marginLeft="calc("+margin+" + "+offsetx+"px)";
			pdfCanvas.style.marginTop=margin;
			pdfCanvas.style.marginRight=margin;
			pdfCanvas.style.marginBottom="calc("+margin+" - "+offsety+"px)";
			break;
		case 2:
			All.style.alignItems="flex-end";
			All.style.justifyContent="center";
			pdfCanvas.style.marginLeft="calc("+margin+" + "+offsetx+"px)";
			pdfCanvas.style.marginTop=margin;
			pdfCanvas.style.marginRight=margin;
			pdfCanvas.style.marginBottom="calc("+margin+" - "+offsety+"px)";
			break;
		case 3:
			All.style.alignItems="flex-end";
			All.style.justifyContent="flex-end";
			pdfCanvas.style.marginLeft=margin;
			pdfCanvas.style.marginTop=margin;
			pdfCanvas.style.marginRight="calc("+margin+" - "+offsetx+"px)";
			pdfCanvas.style.marginBottom="calc("+margin+" - "+offsety+"px)";
			break;
	}
}


//Connect to Twitchchat:
const client = new tmi.Client({
	options: { debug: false },
	channels: TwitchChannel
});
client.connect().catch(console.error);
client.on('message', (channel, user, message, self) => {
	// "Alca: Hello, World!"
	if (user.mod || extraMods.includes(user['display-name'].toLowerCase()) || TwitchChannel.includes("#"+user['display-name'].toLowerCase())){
		//Authorised Users (Twitch Mods, extraMods, Broadcaster or in case of debug-mode: everyone)
		switch (message.split(" ")[0]){
			case EnableCommand:
				pdfCanvas.style.visibility = "visible";
				break;
			case DisableCommand:
				pdfCanvas.style.visibility = "hidden";
				break;
			case NextCommand:
				if (isNaN(message.split(" ")[1]*1)){nextPage();}else{nextPage(message.split(" ")[1]*1);}
				break;
			case PreviousCommand:
				if (isNaN(message.split(" ")[1]*1)){previousPage();}else{previousPage(message.split(" ")[1]*1);}
				break;	
			case SetPageCommand:
				if (isNaN(message.split(" ")[1]*1)){break;}
				jumpToPage(message.split(" ")[1]*1);
				break;
			case RotatePageCommand:
				if (isNaN(message.split(" ")[1]*1)){break;}
				rotate(message.split(" ")[1]*1);
				break;
			case SetScaleCommand:
				let val=message.split(" ")[1].replace(",",".");
				if (isNaN(val*1)){fixedscale(0);break;}
				fixedscale(val*1);
				break;
			case SetPosCommand:
				const text=message.substr(SetPosCommand.length +1).trim();
				
				ChangePosition(text);					
				if (text[0]*1==0){
					All.style.backgroundColor="black";
				}else{
					All.style.backgroundColor="rgba(0,0,0,0)";
				}
				break;
		}
	}
});
	</script>
</body>
</html>
