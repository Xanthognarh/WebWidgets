<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PDF Viewer</title>
    <style>
		body{
			margin:0;
			background-color: rgba(0,0,0,0);
		}
        #canvas-container {
            position: relative;
        }
        canvas {
            border: 0px solid white;
			background-color:lightgreen;
            display: block;
        }
		#All{
			width:100%;
			height:100%;
			position:absolute;
			display:flex;
			align-items:flex-end;
			justify-content:center;
		}
        #Help{
            position:absolute;
            width:100%;
            height:100%;
            margin:0;
            padding:0;
            background-color:rgba(150,150,150,0.5);
        }
        #Placeholder{
            width:100%;
            height:100%;
            margin:0;
            padding:0;
        }
        #Placeholder div{
            width:100%;
            height:100%;
            margin:0;
            padding:0;
            position:absolute;
			display:flex;
        }
        #Placeholder div span {
            width:calc(100vw / 5);
            height:calc(100vh / 5);
            background-color:green;
            text-align:center;
            font-size:calc(100vh / 5);
        }
        #p1{align-items:flex-end;justify-content:flex-start;}
        #p2{align-items:flex-end;justify-content:center;}
        #p3{align-items:flex-end;justify-content:flex-end;}
        #p4{align-items:center;justify-content:flex-start;}
        #p5{align-items:center;justify-content:center;}
        #p6{align-items:center;justify-content:flex-end;}
        #p7{align-items:flex-start;justify-content:flex-start;}
        #p8{align-items:flex-start;justify-content:center;}
        #p9{align-items:flex-start;justify-content:flex-end;}
        #Anleitung{
            position:absolute;
            height:calc(100vh / 5);
            top:calc(100vh / 5);
            font-size:calc(100vh / 20);
            text-align:center;
        }
        #Commands{
            position:absolute;
            height:calc(100vh / 5);
            top:calc(100vh / 5 * 3);
            font-size:calc(100vh / 40);
        }
        strong{
            text-align:initial;
            font-size:inherit;
            display:contents;
            white-space:nowrap;
        }
        #Commands div span{
            background: #7fc3ff;
            margin: 5px;
            border-radius: 10px;
            padding: 4px;
            font-size:calc(100vh / 30);
            line-height: calc(100vh / 30 + 15px);
        }
        #Commands div{
            width:100%;
        }
    </style>
	<script src="Scripts/tmi.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/pdfjs-dist@5/build/pdf.min.mjs"></script>
</head>
<body onclick="document.getElementById('fileInput').click();">
<div id="All">
    <input type="file" id="fileInput" style="display: none;" accept="application/pdf">
    <div id="canvas-container">
        <canvas id="pdfCanvas"></canvas>
    </div>
</div>
<div id="Help">
    <div id="Placeholder">
        <div id="p1"><span>1<span></div>
        <div id="p2"><span>2<span></div>
        <div id="p3"><span>3<span></div>
        <div id="p4"><span>4<span></div>
        <div id="p5"><span>5<span></div>
        <div id="p6"><span>6<span></div>
        <div id="p7"><span>7<span></div>
        <div id="p8"><span>8<span></div>
        <div id="p9"><span>9<span></div>
    </div>
    <div id="Anleitung">Open a PDF by clicking (OBS: Use the 'Interact' Button to open the interactive window) anywhere on this page. A file open dialog should open.</div>
    <div id="Commands"></div>
</div>
    <script type="module" >
const DisableCommand="!hidepdf";
const EnableCommand="!showpdf";
const NextCommand="!pdf+";
const PreviousCommand="!pdf-";
const SetPageCommand="!pdf";
const RotatePageCommand="!pdfrotation";
const SetScaleCommand="!pdfzoom";
const SetPosCommand="!pdfpos";
const ConfigCommand="!pdfconfig";

let rotationangle=0;
let zoom=0;

const extraMods=[]; //only lower-case usernames (like in the url): extraMods=["name1","name2"];

const ranges = [
    [0x0021, 0x007E],         // Basic Latin punctuation, digits, letters (94)
    [0x00A1, 0x00FF],         // Latin-1 Supplement (95)
    [0x0100, 0x017F],         // Latin Extended-A (128)
    [0x0180, 0x024F],         // Latin Extended-B (208)
    [0x0370, 0x03FF],         // Greek and Coptic (144)
    [0x0400, 0x04FF],         // Cyrillic (256)
    [0x0530, 0x058F],         // Armenian (96)
    [0x0590, 0x05FF],         // Hebrew (112)
    [0x0600, 0x06FF],         // Arabic (256)
    [0x0700, 0x074F],         // Syriac (80)
    [0x0780, 0x07BF],         // Thaana (64)
    [0x07C0, 0x07FF],         // NKo (64)
    [0x0800, 0x083F],         // Samaritan (64)
    [0x0840, 0x085F],         // Mandaic (32)
    [0x0900, 0x097F],         // Devanagari (128)
    [0x0980, 0x09FF],         // Bengali (128)
    [0x0A00, 0x0A7F],         // Gurmukhi (128)
    [0x0A80, 0x0AFF],         // Gujarati (128)
    [0x0B00, 0x0B7F],         // Oriya (128)
    [0x0B80, 0x0BFF],         // Tamil (128)
    [0x0C00, 0x0C7F],         // Telugu (128)
    [0x0C80, 0x0CFF],         // Kannada (128)
    [0x0D00, 0x0D7F],         // Malayalam (128)
    [0x0D80, 0x0DFF],         // Sinhala (128)
    [0x0E00, 0x0E7F],         // Thai (128)
    [0x0E80, 0x0EFF],         // Lao (128)
    [0x0F00, 0x0FFF],         // Tibetan (256)
    [0x1000, 0x109F],         // Myanmar (160)
    [0x10A0, 0x10FF],         // Georgian (96)
    [0x1200, 0x137F],         // Ethiopic (384)
    [0x1780, 0x17FF],         // Khmer (128)
    [0x1800, 0x18AF],         // Mongolian (176)
    [0x1E00, 0x1EFF],         // Latin Extended Additional (256)
    [0x1F00, 0x1FFF],         // Greek Extended (256)
    [0x2200, 0x22FF],         // Mathematical Operators (256)
    [0x2600, 0x26FF],         // Miscellaneous Symbols (256)
    [0x2B00, 0x2BFF],         // Misc Symbols & Arrows (256)
    [0x3040, 0x309F],         // Hiragana (96)
    [0x30A0, 0x30FF],         // Katakana (96)
    [0x31F0, 0x31FF],         // Katakana Phonetic Extensions (16)
    [0x3130, 0x318F],         // Hangul Compatibility Jamo (96)
    [0x1F300, 0x1F5FF],       // Miscellaneous Symbols and Pictographs (768)
    [0x1F600, 0x1F64F],       // Emoticons (80)
    [0x1F680, 0x1F6FF],       // Transport & Map Symbols (128)
    [0x1F700, 0x1F77F],       // Alchemical Symbols (128)
    [0x1F780, 0x1F7FF],       // Geometric Shapes Extended (128)
    [0x1F800, 0x1F8FF],       // Supplemental Arrows-C (256)
    [0x1F900, 0x1F9FF],       // Supplemental Symbols and Pictographs (256)
    [0x1FA00, 0x1FA6F],       // Chess Symbols, Symbols & Pictographs (112)
    [0x1FC00, 0x1FCFF],       // Mahjong Tiles (256)
    [0x1FD00, 0x1FDFF],       // Domino Tiles (256)
    [0x1FE00, 0x1FEFF],       // Playing Cards (256)
    [0xFF01, 0xFF9F]          // Halfwidth & Fullwidth Forms (159)
];
const blockSizes = ranges.map(([s,e])=>e-s+1);
const cumSizes = blockSizes.reduce((acc,size,i)=>{
    acc.push((acc[i-1]||0)+size);
    return acc;
}, []);
const totalSize = cumSizes.at(-1);

// 16-bit scrambler (invertible)
function scramble16bit(x){
    x = ((x & 0xAAAA) >> 1) | ((x & 0x5555) << 1);
    x = ((x & 0xCCCC) >> 2) | ((x & 0x3333) << 2);
    x = ((x & 0xF0F0) >> 4) | ((x & 0x0F0F) << 4);
    x = ((x & 0xFF00) >> 8) | ((x & 0x00FF) << 8);
    return x & 0xFFFF;
}
function unscramble16bit(x){ return scramble16bit(x); }
function getIndexFromChar(char){
    const code = char.codePointAt(0);
    let blockIdx = ranges.findIndex(([start,end]) => code >= start && code <= end);
    if(blockIdx === -1) throw new Error("Char not in range: "+char);
    const prevCum = blockIdx>0 ? cumSizes[blockIdx-1] : 0;
    const scaledIndex = prevCum + (code - ranges[blockIdx][0]);
    return unscramble16bit(scaledIndex);
}
function* unicodeChars(str) {
    let i = 0;
    while (i < str.length) {
        const code = str.codePointAt(i);
        yield code;
        i += code > 0xFFFF ? 2 : 1; // skip 2 for surrogate pairs
    }
}
// Decode 5 chars back to 64-bit number
function decode64Bit(str){
    let v=0n;
    let i = 0;
    for (const code of unicodeChars(str)) {
        const ch = String.fromCodePoint(code);
        const idx16 = BigInt(getIndexFromChar(ch));
        const part13 = idx16 >> 3n;
        const shift = BigInt((4-i)*13);
        v |= BigInt(part13 & 0x1FFFn) << shift;
        i++;
    }
    return v;
}
function decompressData(str){
    const v = decode64Bit(str);
    return {
        x: Number((v >> 50n) & 0x3FFFn) - 8191,
        y: Number((v >> 36n) & 0x3FFFn) - 8191,
        scale: Number((v >> 20n) & 0xFFFFn),
        rotation: Number((v >> 18n) & 0x3n),
        visible: Boolean((v >> 17n) & 0x1n),
        page: Number(v & 0x1FFFFn)
    };
}

const siteURL=new URL(window.location);
let TwitchChannel="";
try{
    TwitchChannel=siteURL.searchParams.get("channel").toLowerCase().split(",");
}catch{
    document.getElementById("Anleitung").innerHTML="<strong style='color:red'>!!! Add ?channel=YourChannelName to the URL !!!</strong>";
    throw new Error("Channelname missing in url");
}	
let pos=siteURL.searchParams.get("pos");
if (pos==null){pos="7"}

document.getElementById("Commands").innerHTML=`<div>Commands for Mods and ${[TwitchChannel,extraMods.join(', ')].join(', ')}:</div><div><span>Next Page: <strong>${NextCommand}</strong></span><span> Previous Page: <strong>${PreviousCommand}</strong></span><span> Set Page: <strong>${SetPageCommand}</strong></span><span> Show/Hide: <strong>${EnableCommand}/${DisableCommand}</strong></span><span> Rotate: <strong>${RotatePageCommand}</strong> 0/1=90°/2=180°/3=270°</span><span> Zoom <strong>${SetScaleCommand}</strong> 100</span><span> Move <strong>${SetPosCommand}</strong> 1-9 [offset-x] [offset-y]</span></div>`;
	
	
import { getDocument } from 'https://cdn.jsdelivr.net/npm/pdfjs-dist@5/build/pdf.min.mjs';
pdfjsLib.GlobalWorkerOptions.workerSrc ='https://cdn.jsdelivr.net/npm/pdfjs-dist@5/build/pdf.worker.min.mjs';

let pdfDoc = null;
let currentPage = 1;
const pdfCanvas = document.getElementById('pdfCanvas');
const All=document.getElementById('All');
document.getElementById('fileInput').addEventListener('change', loadPDF);

async function loadPDF(event) {
	const file = event.target.files[0];
	if (file) {
		const fileURL = URL.createObjectURL(file);
		pdfDoc = await pdfjsLib.getDocument(fileURL).promise;
		currentPage = 1;
		renderPage(currentPage);
		ChangePosition(pos);
        document.getElementById("Help").style.visibility="hidden";
	}else{
        document.getElementById("Help").style.visibility="visible";
    }
}
async function renderPage(num) {
	const page = await pdfDoc.getPage(num);
	const desiredHeight = window.screen.availHeight ;
	const desiredWidth = window.screen.availWidth ;
	const viewport = page.getViewport({ scale: 1, rotation: rotationangle});
	let scale = Math.min(desiredHeight / viewport.height, desiredWidth / viewport.width);
	if (zoom!=0){ 
		scale=zoom*scale/100;
	}
	const scaledViewport = page.getViewport({ scale: scale, rotation: rotationangle});

	pdfCanvas.width = scaledViewport.width;
	pdfCanvas.height = scaledViewport.height;
	console.log("Render Page "+num+" with scale "+scale+" and rotation "+rotationangle);
	await page.render({canvasContext: pdfCanvas.getContext('2d'), viewport: scaledViewport}).promise;
}

function nextPage(amount=1) {
	console.log("Next "+amount);
	if (pdfDoc){
		if (currentPage+amount <= pdfDoc.numPages) {
		currentPage+=amount;
		}else{
			currentPage=pdfDoc.numPages;
		}
	renderPage(currentPage);
	}
}

function previousPage(amount=1) {
	console.log("Previous "+amount);
	if (pdfDoc){
		if (currentPage-amount >1) {
		currentPage-=amount;
		}else{
			currentPage=1;
		}
	renderPage(currentPage);
	}
}

function jumpToPage(pageNum) {
	if (pdfDoc && pageNum > 0 && pageNum <= pdfDoc.numPages) {
		currentPage = pageNum;
		renderPage(currentPage);
	}
}

function rotate(angle){
	if (pdfDoc){
		switch(angle){
			case 0:
			case 360:
			case 4:
			rotationangle=0;
			break;
			case 1:
			case 90:
			rotationangle=90;
			break;
			case 2:
			case 180:
			rotationangle=180;
			break;
			case 3:
			case 270:
			rotationangle=270;
			break;
		}
		renderPage(currentPage);
	}
}

function fixedscale(val=0){
	zoom=val;
	renderPage(currentPage);
}

function ChangePosition(text){
	let offsetx=text.split(" ")[1]*1;
	let offsety=text.split(" ")[2]*1;
	if (isNaN(offsety)){offsety=0;}
	if (isNaN(offsetx)){offsetx=0;}
	const margin="0%";
	pos=text[0]*1;
	switch (pos){
		case 7:
			All.style.alignItems="flex-start";
			All.style.justifyContent="flex-start";
			pdfCanvas.style.marginLeft="calc("+margin+" + "+offsetx+"px)";
			pdfCanvas.style.marginTop="calc("+margin+" + "+offsety+"px)";
			pdfCanvas.style.marginRight=margin;
			pdfCanvas.style.marginBottom=margin;
			break;
		case 8:
			All.style.alignItems="flex-start";
			All.style.justifyContent="center";
			pdfCanvas.style.marginLeft="calc("+margin+" + "+offsetx+"px)";
			pdfCanvas.style.marginTop="calc("+margin+" + "+offsety+"px)";
			pdfCanvas.style.marginRight=margin;
			pdfCanvas.style.marginBottom=margin;
			break;
		case 9:
			All.style.alignItems="flex-start";
			All.style.justifyContent="flex-end";
			pdfCanvas.style.marginLeft=margin;
			pdfCanvas.style.marginTop="calc("+margin+" + "+offsety+"px)";
			pdfCanvas.style.marginRight="calc("+margin+" - "+offsetx+"px)";
			pdfCanvas.style.marginBottom=margin;
			break;
			
		case 4:
			All.style.alignItems="center";
			All.style.justifyContent="flex-start";
			pdfCanvas.style.marginLeft="calc("+margin+" + "+offsetx+"px)";
			pdfCanvas.style.marginTop="calc("+margin+" + "+offsety+"px)";
			pdfCanvas.style.marginRight=margin;
			pdfCanvas.style.marginBottom=margin;
			break;
		case 5:
			All.style.alignItems="center";
			All.style.justifyContent="center";
			pdfCanvas.style.marginLeft="calc("+margin+" + "+offsetx+"px)";
			pdfCanvas.style.marginTop="calc("+margin+" + "+offsety+"px)";
			pdfCanvas.style.marginRight=margin;
			pdfCanvas.style.marginBottom=margin;
			break;
		case 6:
			All.style.alignItems="center";
			All.style.justifyContent="flex-end";
			pdfCanvas.style.marginLeft=margin;
			pdfCanvas.style.marginTop="calc("+margin+" + "+offsety+"px)";
			pdfCanvas.style.marginRight="calc("+margin+" - "+offsetx+"px)";
			pdfCanvas.style.marginBottom=margin;
			break;
		
		case 1:
			All.style.alignItems="flex-end";
			All.style.justifyContent="flex-start";
			pdfCanvas.style.marginLeft="calc("+margin+" + "+offsetx+"px)";
			pdfCanvas.style.marginTop=margin;
			pdfCanvas.style.marginRight=margin;
			pdfCanvas.style.marginBottom="calc("+margin+" - "+offsety+"px)";
			break;
		case 2:
			All.style.alignItems="flex-end";
			All.style.justifyContent="center";
			pdfCanvas.style.marginLeft="calc("+margin+" + "+offsetx+"px)";
			pdfCanvas.style.marginTop=margin;
			pdfCanvas.style.marginRight=margin;
			pdfCanvas.style.marginBottom="calc("+margin+" - "+offsety+"px)";
			break;
		case 3:
			All.style.alignItems="flex-end";
			All.style.justifyContent="flex-end";
			pdfCanvas.style.marginLeft=margin;
			pdfCanvas.style.marginTop=margin;
			pdfCanvas.style.marginRight="calc("+margin+" - "+offsetx+"px)";
			pdfCanvas.style.marginBottom="calc("+margin+" - "+offsety+"px)";
			break;
	}
}


//Connect to Twitchchat:
const client = new tmi.Client({
	options: { debug: false },
	channels: TwitchChannel
});
client.connect().catch(console.error);
client.on('message', (channel, user, message, self) => {
	// "Alca: Hello, World!"
	if (user.mod || extraMods.includes(user['display-name'].toLowerCase()) || TwitchChannel.includes("#"+user['display-name'].toLowerCase())){
		//Authorised Users (Twitch Mods, extraMods, Broadcaster or in case of debug-mode: everyone)
		switch (message.split(" ")[0]){
			case EnableCommand:
				pdfCanvas.style.visibility = "visible";
				break;
			case DisableCommand:
				pdfCanvas.style.visibility = "hidden";
				break;
			case NextCommand:
				if (isNaN(message.split(" ")[1]*1)){nextPage();}else{nextPage(message.split(" ")[1]*1);}
				break;
			case PreviousCommand:
				if (isNaN(message.split(" ")[1]*1)){previousPage();}else{previousPage(message.split(" ")[1]*1);}
				break;	
			case SetPageCommand:
				if (isNaN(message.split(" ")[1]*1)){break;}
				jumpToPage(message.split(" ")[1]*1);
				break;
			case RotatePageCommand:
				if (isNaN(message.split(" ")[1]*1)){break;}
				rotate(message.split(" ")[1]*1);
				break;
			case SetScaleCommand:
				let val=message.split(" ")[1].replace(",",".");
				if (isNaN(val*1)){fixedscale(0);break;}
				fixedscale(val*1);
				break;
			case SetPosCommand:
				const text=message.substr(SetPosCommand.length +1).trim();
				
				ChangePosition(text);					
				if (text[0]*1==0){
					All.style.backgroundColor="black";
				}else{
					All.style.backgroundColor="rgba(0,0,0,0)";
				}
				break;
            case ConfigCommand:
                const encoded=message.split(" ")[1];
                console.log(encoded);
                const data=decompressData(encoded);
                console.log(data);
                pdfCanvas.style.visibility = data.visible ? "visible" : "hidden";
                jumpToPage(data.page);
                rotate(data.rotation);
                fixedscale(data.scale);
                ChangePosition(`7 ${data.x} ${data.y}`);
                break;
		}
	}
});
	</script>
</body>
</html>
